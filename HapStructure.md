# HAP Signing Block Structure

This document focuses on the byte-level layout of the HAP signing block and
the related sub-blocks.

```text
HAP Signing Block (inserted before Central Directory)
Offset 0
┌──────────────────────────────────────────────────────────────────────────────┐
│ SubBlockHead[0] (12 bytes)                                                   │
│   uint32 type                                                                │
│   uint32 length                                                              │
│   uint32 offset   // relative to start of signing block                      │
├──────────────────────────────────────────────────────────────────────────────┤
│ SubBlockHead[1] (12 bytes)                                                   │
│   ...                                                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│ ...                                                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│ SubBlockHead[N-1] (12 bytes)                                                 │
├──────────────────────────────────────────────────────────────────────────────┤
│ SubBlockValue[0] (length bytes)                                              │
│   // optionalBlocks in vector order                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│ SubBlockValue[1]                                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│ ...                                                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│ SubBlockValue[N-1]                                                           │
│   // usually the main signature block                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│ SigningBlockTail (32 bytes)                                                  │
│   int32  blockCount = N                                                      │
│   int64  blockSize  = total size of signing block                            │
│   16B    magic      = V2/V3 magic (by compatibleVersion)                     │
│   int32  version    = 2 or 3                                                 │
└──────────────────────────────────────────────────────────────────────────────┘
```

**Sub-block types and value formats:**

- `0x20000000` (HAP_SIGNATURE_SCHEME_V1_BLOCK_ID)
  - Meaning: main HAP signature block (PKCS7 over encoded digest list)
  - Value: PKCS7 SignedData bytes (includes signed content and certificate chain)
  - PKCS7 signed content (the "original data"):
    ```text
    int32 version      // fixed 2
    int32 blockCount   // fixed 1 (current implementation)
    repeat for each pair:
      int32 pairLen    // = 4 + 4 + digestLen
      int32 algId      // digest algorithm id
      int32 digestLen
      bytes digest     // final digest of ZIP chunks + optional blocks
    ```

- `0x20000001` (HAP_PROOF_OF_ROTATION_BLOCK_ID)
  - Meaning: proof-of-rotation data for key/cert rotation
  - Value: raw file bytes (read directly from the user-provided proof file)

- `0x20000002` (HAP_PROFILE_BLOCK_ID)
  - Meaning: application profile content
  - Value: raw file bytes (profile JSON or signed profile p7b as-is)

- `0x20000003` (HAP_PROPERTY_BLOCK_ID)
  - Meaning: optional property/extension data; codesign payload is also stored as a PROPERTY block when enabled
  - Value: raw property file bytes (if provided)
  - If signCode is enabled, an additional PROPERTY block is inserted whose value is:
    ```text
    uint32 type   = 0x30000001 (HAP_CODE_SIGN_BLOCK_ID)
    uint32 length
    uint32 offset   // absolute file offset of codeSignArray in the HAP
    bytes  codeSignArray   // generated by CodeSigning::GetCodeSignBlock
    ```
  - Note: `0x30000001` (HAP_CODE_SIGN_BLOCK_ID) is NOT a top-level sub-block type.
    It only appears as an inner header inside the PROPERTY block value.
    The embedded offset is absolute; sub-block head offsets are signing-block-relative.

```text
CodeSignBlock (codeSignArray)
┌───────────────────────────────────────────────────────────┐
│ CodeSignBlockHeader (32 bytes)                            │
│   int64 magic                                             │
│   int32 version                                           │
│   int32 blockSize                                         │
│   int32 segmentNum                                        │
│   int32 flags                                             │
│   byte[8] reserved                                        │
├───────────────────────────────────────────────────────────┤
│ SegmentHeader[segmentNum] (each 12 bytes)                 │
│   int32 type   (1=FS_VERITY_INFO, 2=HAP_META, 3=NATIVE)   │
│   int32 offset (relative to codeSignBlock start)          │
│   int32 size                                              │
├───────────────────────────────────────────────────────────┤
│ zeroPadding (for 4K alignment of merkle tree)             │
├───────────────────────────────────────────────────────────┤
│ HAP MerkleTree bytes (size from SignInfo extension)       │
├───────────────────────────────────────────────────────────┤
│ FsVerityInfoSegment (64 bytes)                            │
│   int32 magic                                             │
│   int8  version                                           │
│   int8  hashAlgorithm                                     │
│   int8  log2BlockSize                                     │
│   byte[57] reserved                                       │
├───────────────────────────────────────────────────────────┤
│ HapInfoSegment                                            │
│   int32 magic                                             │
│   SignInfo (variable)                                     │
│     int32 saltSize                                        │
│     int32 sigSize                                         │
│     int32 flags                                           │
│     int64 dataSize                                        │
│     byte[saltSize or 32] salt                             │
│     int32 extensionNum                                    │
│     int32 extensionOffset                                 │
│     byte[sigSize] signature                               │
│     padding (4-byte alignment)                            │
│     Extension list (usually MerkleTreeExtension)          │
│       int32 type                                          │
│       int32 size                                          │
│       int64 merkleTreeSize                                │
│       int64 merkleTreeOffset                              │
│       byte[64] rootHash                                   │
├───────────────────────────────────────────────────────────┤
│ NativeLibInfoSegment (variable)                           │
│   int32 magic                                             │
│   int32 segmentSize                                       │
│   int32 sectionNum                                        │
│   SignedFilePos[sectionNum] (each 16 bytes)               │
│     int32 fileNameOffset                                  │
│     int32 fileNameSize                                    │
│     int32 signInfoOffset                                  │
│     int32 signInfoSize                                    │
│   fileNameList bytes                                      │
│   padding (4-byte alignment)                              │
│   SignInfo list (one per native entry)                    │
└───────────────────────────────────────────────────────────┘
```

Offset notes:
- Sub-block head `offset` is relative to the start of the HAP signing block.
- The embedded codesign header `offset` is an absolute file offset in the HAP.



**HAP signing flow (detailed, based on the current code)**

1) Read params and certificates
   - CheckParams collects input/output/alg/profile/property/proof/signCode/etc.
   - LoadOptionalBlocks reads profile/property/proof files into optionalBlocks.
   - Certificates are loaded from appCertFile (PEM chain).

2) Prepare output ZIP
   - Copy ZIP with alignment; remove any existing signing block.
   - Find EOCD and Central Directory; build three DataSources:
     entries (before CD), central directory, EOCD.

3) codesign (optional, when signCode=1 and format is supported)
   - Signs HAP code-related content: the main HAP data region and native entries
     (e.g., libs/* and .an files).
   - Purpose: add an extra integrity layer for executable/native content.
   - The codesign payload is embedded into a PROPERTY optional block and inserted
     before any existing PROPERTY block (so two PROPERTY blocks can coexist).

4) Main HAP signature (PKCS7)
   - Compute chunk digests for the 3 ZIP segments (1MB chunks).
   - Compute final digest that also includes optionalBlocks.
   - Encode the digest list into a byte array (version, count, pairs).
   - Generate PKCS7 SignedData over that encoded digest list.

**HAP digest computation (byte-level, as implemented)**

Inputs:
- Three data sources in this order:
  1) ZIP entry contents (from file start to signing block)
  2) Central Directory
  3) EOCD (End of Central Directory)
- Optional blocks (profile/property/proof, plus codesign property block if enabled)
- Digest algorithm determined by `signAlg` (SHA-256 / SHA-384 / SHA-512)

Step A: Per-chunk digest list (1MB chunks)
```
chunkDigest = 0x5A || chunkCount (int32) ||
              H( 0xA5 || chunkLen(int32) || chunkData[0] ) ||
              H( 0xA5 || chunkLen(int32) || chunkData[1] ) ||
              ...
```
- `0x5A` is ZIP_FIRST_LEVEL_CHUNK_PREFIX
- `0xA5` is ZIP_SECOND_LEVEL_CHUNK_PREFIX
- `chunkLen` is the actual size of the chunk (<= 1MB)
- `H(...)` is the selected hash (SHA-256/384/512)
- `chunkCount` counts chunks across ALL three data sources, in order
- Integers are written in native endianness (memcpy of int32)

Step B: Final digest (includes optional blocks)
```
finalDigest = H( chunkDigest || optionalBlock[0] || optionalBlock[1] || ... )
```
- Optional blocks are appended in vector order (affects the digest)

Step C: Encode for PKCS7 signed content
```
int32 version      // fixed 2
int32 blockCount   // fixed 1 (current implementation)
repeat for each pair:
  int32 pairLen    // = 4 + 4 + digestLen
  int32 algId      // signature algorithm id (e.g., SHA256withECDSA -> 0x201)
  int32 digestLen
  bytes digest     // finalDigest from Step B
```

5) Build HAP signing block
   - Concatenate sub-block heads (type/length/offset) and sub-block values
     (optional blocks + main signature block).
   - Append tail (blockCount, blockSize, magic, version).

6) Write output
   - Insert signing block before Central Directory.
   - Update EOCD with new Central Directory offset.
   - Write [signing block + central directory + EOCD] to output.

**HAP verify flow (matches the signing flow)**

1) Locate and parse the signing block
   - Find EOCD and Central Directory offset.
   - Read the HAP signing block header/tail and parse sub-block heads.
   - Extract main signature block (PKCS7) and optional blocks (profile/property/proof).

2) codesign verify (if present)
   - From the PROPERTY block value, parse the embedded codesign header
     (type=0x30000001, length, offset).
   - Read codeSignArray from the HAP file using the absolute file offset.
   - Verify codesign:
     * HAP data region signature (fs-verity digest + merkle tree)
     * native entries signature (libs/* and .an files)
     * ownerID check from profile content

3) Verify PKCS7 and extract digest info
   - Cryptographically verify PKCS7 SignedData (signature + cert chain).
   - Parse PKCS7 SignedData from the main signature block.
   - Extract the signed content (encoded digest list) and algorithm id.
   - Optionally output certificate chain from PKCS7.

4) Verify HAP integrity
   - Recompute chunk digests for the 3 ZIP segments:
     entries (before CD), central directory, EOCD.
   - Combine optionalBlocks into the final digest (same as signing).
   - Compare recomputed digest with the digest inside PKCS7 signed content.

5) Output optional blocks (if requested)
   - Write profile/property/proof blocks to output files.

Key data structures used in verify
- HAP signing block: sub-block heads + sub-block values + tail (blockCount/size/magic/version)
- Main signature block value: PKCS7 SignedData bytes
- PKCS7 signed content: encoded digest list (version, count, pairs)
- Pair in digest list: (algId, digestBytes); each pair is encoded as
  pairLen + algId + digestLen + digestBytes.
- Optional blocks: raw bytes for profile/property/proof (property may embed codesign header+payload)
- Optional block order is the vector order and affects the final digest.

Glossary:
- signing block: the data region inserted before the Central Directory.
- sub-block: a typed (type/length/offset) entry inside the signing block.
- optional block: profile/property/proof sub-blocks provided by external files.
- codesign: optional extra integrity layer for native/executable content.

#### **A simplified PKCS#7 Example Structure**

```
ContentInfo
 └── SignedData
     ├── digestAlgorithms
     ├── encapContentInfo
     │    └── Data
     ├── certificates
     └── signerInfos
          └── SignerInfo
               ├── signedAttrs
               └── signature
```

#### **A much more complete CMS / PKCS#7 SignedData structure**

This is a **structure-accurate tree view**, closely matching **RFC 5652**, though still presented in a readable form (not raw ASN.1):

```ContentInfo
ContentInfo
├── contentType = signedData (1.2.840.113549.1.7.2)
└── content [0] EXPLICIT
    └── SignedData
        ├── version
        ├── digestAlgorithms (SET OF)
        │    └── DigestAlgorithmIdentifier
        │         ├── algorithm (OID, e.g. sha256)
        │         └── parameters (OPTIONAL)
        ├── encapContentInfo
        │    └── EncapsulatedContentInfo
        │         ├── eContentType (OID, usually data)
        │         └── eContent [0] EXPLICIT OPTIONAL
        │              └── OCTET STRING (payload, may be absent)
        ├── certificates [0] IMPLICIT OPTIONAL
        │    └── CertificateSet (SET OF)
        │         ├── X.509 end-entity certificate
        │         └── intermediate CA certificates
        ├── crls [1] IMPLICIT OPTIONAL
        │    └── RevocationInfoChoices
        └── signerInfos (SET OF)
             └── SignerInfo
                  ├── version
                  ├── sid (SignerIdentifier)
                  │    ├── issuerAndSerialNumber
                  │    └── subjectKeyIdentifier
                  ├── digestAlgorithm
                  ├── signedAttrs [0] IMPLICIT OPTIONAL
                  │    └── SignedAttributes (SET OF)
                  │         ├── contentType
                  │         ├── messageDigest
                  │         ├── signingTime (optional)
                  │         └── other attributes
                  ├── signatureAlgorithm
                  ├── signature (OCTET STRING)
                  └── unsignedAttrs [1] IMPLICIT OPTIONAL
                       └── UnsignedAttributes (SET OF)
                            └── timeStampToken, etc.
